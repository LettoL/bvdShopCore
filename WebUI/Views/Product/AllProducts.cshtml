
@{
    ViewData["Title"] = "AllProducts";
    Layout = "~/Views/Shared/AdminLayout.cshtml";
}

<h3 class="page-title">Все товары <small>Просмотр и редактирование товаров</small></h3>
<div id="change_success" hidden class="change_success">Изменение цены прошло успешно</div>
<div id='allProductsComponent' class="row">
    <div class="col-md-12">
        <div class="portlet">
            <div class="portlet-title">
                <div class="portlet-head">
                    Список товаров
                </div>
                <div class="portlet-filters">
                    <form id="productFilter" style="display: inline-block" >
                        <select name="shopId" id="shopFilter"  class="form-control" style="width: 200px; display: inline-block">
                            <option value="0" disabled selected>Выбрать Магазин</option>
                            <option value="0">Все</option>
                            @foreach (var s in ViewBag.Shops)
                            {
                                <option value="@s.Id">@s.Title</option>
                            }
                        </select>
                        <select name="categoryId" id="categoryFilter" class="form-control" style="width: 200px; display: inline-block">
                            <option value="0" disabled selected>Выбрать Категорию</option>
                            <option value="0">Все</option>
                            @foreach (var c in ViewBag.Categories)
                            {
                                <option value="@c.Id">@c.Title</option>
                            }
                        </select>
                  
                        <input id="searchProduct" type="text" name="title" class="form-control" style="width: 200px; display: inline-block" placeholder="Поиск по названию" />
                        <button type="submit" class="btn btn-dark" style="vertical-align: top">Поиск</button>
                    </form>
                </div>
                <div class="portlet-action">
                    <a href="/Product/Create" class="btn add-button">Новый Товар</a>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="portlet-body">
                <div class="table-responsive">
                    <table id="result" class="table table-striped">
                        <thead>
                            <tr>
                                <th>Артикул</th>
                                <th>Название</th>
                                <th>Количество</th>
                                <th>Цена</th>
                                <th>Магазин</th>
                                <th>Категория</th>
                                <th>Действие</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for='item in products' id="item.Id">
                                <td>{{item.code}}</td>
                                <td>{{item.title}}</td>
                                <td>{{item.amount}}</td>
                                <td contenteditable>{{item.cost}}</td>
                                <td>{{item.shop.title}}</td>
                                <td>{{item.category.title}}</td>
                                <td>
                                    <a href="'/Product/Detail/' + item.id" class="btn btn-dark">
                                        <i class="fa fa-arrow-right" aria-hidden="true"></i>
                                    </a>
                                    <a href="'/Product/Edit/' + item.Id" class="btn btn-dark">
                                        <i class="fa fa-pencil" aria-hidden="true"></i>
                                    </a>
                                    <button id="updatePrice" class="btn btn-dark">
                                        <i class="fa fa fa-check" aria-hidden="true"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>

<script>
    const productsList = new Vue({
        el: '#allProductsComponent',
        data: {
            products: []
        },
        created: function () {
            fetch('/Product/GetAllProducts', {
                headers: {'Content-Type': 'application/json'},
                credentials: 'include'
            })
            .then((res) => {
                return res.json()
            })
            .then((res) => {
                this.products = res;
            })
        }
    })
</script>

<script type="text/javascript">

    let form = document.getElementById('productFilter');

    let categoryId = 0;
    let shopId = 0;
    let userId = @ViewBag.UserId;
    let title = null;
    let all = "true";

    form.addEventListener('submit', filter);

    function filter(event) {

        event.preventDefault();

        shopId = document.getElementById('shopFilter').value;
        categoryId = document.getElementById('categoryFilter').value;
        title = document.getElementById('searchProduct').value;

        let ProductFilterVM = {
            ProductFiltrationModel: {
                categoryId: categoryId,
                shopId: shopId,
                title: title,
                all: all
            },
            userId: userId
        }

        $('#result').load(
            "/Product/Filter",
            ProductFilterVM
        );

    }

    let price;
    let productId;

    let table = document.getElementById('result');
    table.addEventListener('input', function (event) {
        price = +event.target.innerText.replace(',', '.');
        productId = +event.srcElement.parentElement.id;
    });


    table.addEventListener('click', function (event) {
        if (event.srcElement.id == "updatePrice" || event.srcElement.parentElement.id == "updatePrice") {
            if (isNaN(price))
                alert('Цена должна быть числом')

            var changeProduct = {
                price: JSON.stringify(price).replace('.', ','),
                productId: productId
            }

            if (!isNaN(price)) {
                fetch('/Product/ChangePrice', {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(changeProduct)
                }).then(res => {
                    if (res.ok == true) {
                        let change_success = document.getElementById('change_success');
                        change_success.hidden = false;

                        setTimeout(() => change_success.hidden = true, 1200)
                    }
                        
                })
            }
            
        }       
    });

</script>
